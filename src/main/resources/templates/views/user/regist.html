<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/default}">

<th:block layout:fragment="link">
    <!-- 여기에 연결할 외부 CSS 링크를 지정 -->
    <!-- 생성한 CSS 파일은 `/resources/static/css` 에 넣어주세요. -->
    <link rel="stylesheet" th:href="@{/css/user.css}" href="/css/user.css"/>
</th:block>

<th:block layout:fragment="content">
    <div class="sub-content">
        <div class="inner">
            <!-- 한 페이지 당 컨텐츠는 section으로 묶습니다. -->
            <section class="section">
                <div class="titleWrap">
                    <h2>회원가입</h2>
                    <h5><span class="red_star">*</span>필수입력사항</h5>
                </div>
                <form class="regist_form" action="/user/regist" method="post">
                    <div class="registWrap">
                        <div class="inputWrap form-group last mb-4 email_input">
                            <label for="memail" id="mailTxt">이메일<span class="red_star">*</span></label>
                            <div class="input_box">
                                <input type="email" class="form-control" name="email" id="memail"
                                       placeholder="이메일을 입력해주세요."
                                       required/>
                                <button class="btn btn-outline-primary" type="button" id="checkEmail">인증</button>
                            </div>
                        </div>
                        <div class="inputWrap">
                            <label for="memailconfirm">인증번호<span
                                    class="red_star">*</span></label>
                            <div class="input_box">
                                <input type="text" class="form-control" id="memailconfirm"
                                       placeholder="인증번호 입력"/>
                                <button class="btn btn-outline-primary" type="button" id="checkEmailNum">확인</button>
                            </div>
                        </div>
                        <div id="memailconfirmTxt"></div>
                        <div class="inputWrap">
                            <label for="user_name">이름<span class="red_star">*</span></label>
                            <div class="input_box">
                                <input type="text" name="name" id="user_name" placeholder="이름을 입력해주세요." required/>
                            </div>
                        </div>
                        <div class="inputWrap">
                            <label for="password">비밀번호<span class="red_star">*</span></label>
                            <div class="input_box">
                                <input type="password" name="password" id="password"
                                       placeholder="비밀번호를 입력해주세요. (문자, 숫자, 특수문자 포함 8자 ~ 20자 이내)" required/>
                            </div>
                        </div>
                        <div class="inputWrap">
                            <label for="userId">아이디<span class="red_star">*</span></label>
                            <div class="input_box">
                                <input type="text" name="userId" id="userId"
                                       placeholder="아이디를 입력해주세요.(영어,숫자 포함 5자 ~ 11자 이내)" maxlength="11" required/>
                                <button type="button" id="duplicationCheck" value="중복확인" disabled>중복확인</button>
                            </div>
                        </div>
                        <div class="success-message hide col_red">사용할 수 있는 아이디입니다</div>
                        <div class="failure-message hide col_red">아이디는 5~11글자이어야 합니다</div>
                        <div class="failure-message2 hide col_red">영어 또는 숫자만 가능합니다</div>
                        <div class="failure-message3 hide col_red">이미 존재하는 아이디입니다</div>
                        <div class="inputWrap">
                            <label for="nickname">닉네임<span class="red_star">*</span></label>
                            <div class="input_box">
                                <input type="text" name="nickname" id="nickname" placeholder="닉네임을 입력해주세요."
                                       required/>
                                <button type="button" id="nicknameDuplicationCheck">중복확인</button>
                            </div>
                        </div>
                        <div class="inputWrap">
                            <label for="user_date">생년월일<span class="red_star">*</span></label>
                            <div class="input_box">
                                <input type="date" name="birth" id="user_date" placeholder="YY /   MM   /    DD"
                                       required/>
                            </div>
                        </div>
                    </div>
                    <div class="agreeWrap">
                        <div class="inputWrap">
                            <label for="user_date">이용약관동의<span class="red_star">*</span></label>
                            <div class="checkBoxWrap">
                                <div class="check_box">
                                    <input type="checkbox" id="agree_all"/>
                                    <label for="agree_all">
                                        <span></span>
                                        <p>
                                            전체 동의합니다.
                                        </p>
                                    </label>
                                </div>
                                <div class="check_box">
                                    <input type="checkbox" id="agree_check1" class="normal"/>
                                    <label for="agree_check1">
                                        <span></span>
                                        <p>
                                            이용약관 동의(필수)
                                        </p>
                                    </label>
                                </div>
                                <div class="check_box">
                                    <input type="checkbox" id="agree_check2" class="normal"/>
                                    <label for="agree_check2">
                                        <span></span>
                                        <p>
                                            이용약관 동의(필수)
                                        </p>
                                    </label>
                                </div>
                                <div class="check_box">
                                    <input type="checkbox" id="agree_check3" class="normal"/>
                                    <label for="agree_check3">
                                        <span></span>
                                        <p>
                                            이용약관 동의(필수)
                                        </p>
                                    </label>
                                </div>
                                <div class="check_box">
                                    <input type="checkbox" id="agree_check4" class="normal"/>
                                    <label for="agree_check4">
                                        <span></span>
                                        <p>
                                            본인은 만 14세 이상입니다.
                                        </p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="black_btns btns">
                        <button class="btn" type="submit">가입하기</button>
                    </div>
                </form>
            </section>
            <!-- ------------------------------------ -->
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
    <!-- 여기에 연결할 외부 javascript 링크를 지정 -->
    <!-- 생성한 CSS 파일은 `/resources/static/js` 에 넣어주세요. -->
    <script th:src="@{/js/common.js}" src="/js/common.js"></script>
    <script th:src="@{/js/event.js}" src="/js/event.js"></script>
    <script th:src="@{/js/user.js}" src="/js/user.js"></script>
    <script th:src="@{/js/agree.js}" src="/js/agree.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 전체 동의 체크박스
            var agreeAllCheckbox = document.getElementById("agree_all");
            // 다른 동의 체크박스들
            var agreeCheckboxes = document.querySelectorAll(".normal");

            // 전체 동의 체크박스의 변경 이벤트 리스너 추가
            agreeAllCheckbox.addEventListener("change", function () {
                // 전체 동의 체크박스의 상태에 따라 다른 동의 체크박스 상태 변경
                agreeCheckboxes.forEach(function (checkbox) {
                    checkbox.checked = agreeAllCheckbox.checked;
                });
            });

            // 다른 동의 체크박스들의 변경 이벤트 리스너 추가
            agreeCheckboxes.forEach(function (checkbox) {
                checkbox.addEventListener("change", function () {
                    // 다른 동의 체크박스 중 하나라도 선택 해제되면 전체 동의 체크박스의 선택도 해제
                    if (!this.checked) {
                        agreeAllCheckbox.checked = false;
                    } else {
                        // 모든 다른 동의 체크박스가 선택되었는지 확인하여 전체 동의 체크박스 선택 여부 업데이트
                        var allChecked = true;
                        agreeCheckboxes.forEach(function (checkbox) {
                            if (!checkbox.checked) {
                                allChecked = false;
                            }
                        });
                        agreeAllCheckbox.checked = allChecked;
                    }
                });
            });
        });
    </script>
    <script>
        const $checkEmail = document.querySelector("#checkEmail");
        const $memail = document.querySelector("#memail");
        const $memailconfirmTxt = document.querySelector("#memailconfirmTxt");

        // 서버에서 받은 이메일 중복 여부
        let isEmailDuplicate = false;

        // 이메일 인증번호
        $checkEmail.addEventListener("click", function () {
            $.ajax({
                type: "POST",
                url: "/user/mailConfirm",
                data: {
                    "email": $memail.value
                },
                success: function (data) {
                    alert("해당 이메일로 인증번호 발송이 완료되었습니다. \n 확인부탁드립니다.")
                    console.log("data : " + data);
                }
            })
        })

        const $checkEmailNum = document.querySelector("#checkEmailNum");
        const $memailconfirm = document.querySelector("#memailconfirm");

        /* 인증번호 확인 start */
        function checkEmailNum() {
            fetch("/user/mailConfirmNum", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                },
                body: new URLSearchParams({memailconfirm: $memailconfirm.value})
            })
                .then(response => {
                    if (response.ok) { // 성공 응답을 받았을 때
                        return response.text(); // 응답 내용을 텍스트로 반환
                    } else {
                        throw new Error('Network response was not ok.'); // 오류 응답을 처리
                    }
                })
                .then(data => {
                    if (data === "") { // 서버로부터 받은 응답이 빈 문자열인 경우
                        alert("인증번호 확인 완료!"); // 인증번호 확인 완료 메시지 표시
                    } else {
                        throw new Error('Invalid confirmation number.'); // 서버로부터 받은 응답이 유효하지 않은 경우
                    }
                })
                .catch(error => {
                    console.error('There was a problem with your fetch operation:', error);
                    alert("인증번호가 잘못되었습니다."); // 오류 메시지 표시
                });
        }

        /* 인증번호 확인 end */

        $checkEmailNum.addEventListener("click", checkEmailNum);

        document.addEventListener("DOMContentLoaded", function () {
            // 이메일 입력란과 인증 버튼 요소 참조
            var $memail = document.getElementById("memail");
            var $checkEmail = document.getElementById("checkEmail");

            // 페이지 로드시 초기 버튼 상태 설정
            checkEmailValidity();

            // 이메일 입력란의 내용이 변경될 때마다 이벤트 리스너 추가
            $memail.addEventListener("input", function () {
                checkEmailValidity();
                // 입력된 이메일 주소
            });

            // 인증 버튼의 활성화 여부를 검사하는 함수
            function checkEmailValidity() {
                // 입력된 이메일 주소
                var emailValue = $memail.value.trim();

                // 이메일 주소가 유효한지 확인
                var isValidEmail = validateEmail(emailValue);

                // 유효한 이메일 주소라면 인증 버튼 활성화
                // 그렇지 않다면 비활성화
                if (isValidEmail) {
                    $checkEmail.disabled = false;
                } else {
                    $checkEmail.disabled = true;
                }
            }
        });

        // 이메일 주소 유효성 검사 함수
        function validateEmail(email) {
            // 간단한 이메일 형식 검사 (더 엄격한 검사가 필요할 수 있음)
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // 회원가입 버튼 클릭 시 서버로 이메일 중복 여부 요청
        document.querySelector(".btn[type='submit']").addEventListener("click", function (event) {
            // 이미 중복된 이메일이면 가입을 막음
            if (isEmailDuplicate) {
                event.preventDefault(); // 회원가입 이벤트 중지
                alert("이미 등록된 이메일입니다.");
            }
        });
    </script>
</th:block>
</html>