<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/default}">

<th:block layout:fragment="link">
    <link rel="stylesheet" th:href="@{/css/sub.css}" href="/css/sub.css"/>
    <!-- 여기에 연결할 외부 CSS 링크를 지정 -->
    <!-- 생성한 CSS 파일은 `/resources/static/css` 에 넣어주세요. -->
    <link rel="stylesheet" th:href="@{/css/user.css}" href="/css/user.css"/>
</th:block>

<th:block layout:fragment="content">
    <div class="sub-content">
        <div class="inner">
            <!-- 한 페이지 당 컨텐츠는 section으로 묶습니다. -->
            <section class="section">
                <div class="secession">
                    <h2 class="secession_title">정말 떠나시는 건가요?
                        <br/>한 번 더 생각해 보지 않으시겠어요?
                    </h2>
                    <form action="/user/delete" method="post">
                        <div class="secessionWrap">
                            <div class="check_box">
                                <input type="checkbox" id="agree_check1" name="secessionCheckbox"
                                       onchange="checkboxGroup(this)" value="1"/>
                                <label for="agree_check1">
                                    <span></span>
                                    <p>
                                        기록 삭제 목적
                                    </p>
                                </label>
                            </div>
                            <div class="check_box">
                                <input type="checkbox" id="agree_check1" name="secessionCheckbox"
                                       onchange="checkboxGroup(this)" value="2"/>
                                <label for="agree_check1">
                                    <span></span>
                                    <p>
                                        이용이 불편하고 장애가 많아서
                                    </p>
                                </label>
                            </div>
                            <div class="check_box">
                                <input type="checkbox" id="agree_check1" name="secessionCheckbox"
                                       onchange="checkboxGroup(this)" value="3"/>
                                <label for="agree_check1">
                                    <span></span>
                                    <p>
                                        포인트가 비싸서
                                    </p>
                                </label>
                            </div>
                            <div class="check_box">
                                <input type="checkbox" id="agree_check1" name="secessionCheckbox"
                                       onchange="checkboxGroup(this)" value="4"/>
                                <label for="agree_check1">
                                    <span></span>
                                    <p>
                                        다른 사이트가 좋아서
                                    </p>
                                </label>
                            </div>
                            <div class="check_box">
                                <input type="checkbox" id="agree_check1" name="secessionCheckbox"
                                       onchange="checkboxGroup(this)" value="5"/>
                                <label for="agree_check1">
                                    <span></span>
                                    <p>
                                        사용 빈도가 낮아서
                                    </p>
                                </label>
                            </div>
                            <div class="check_box">
                                <input type="checkbox" id="agree_check1" name="secessionCheckbox"
                                       onchange="checkboxGroup(this)" value="6"/>
                                <label for="agree_check1">
                                    <span></span>
                                    <p>
                                        기타
                                    </p>
                                </label>
                            </div>
                        </div>
                        <div class=""></div>
                        <div class="check_box">
                            <input type="checkbox" id="agree_check1" name="secessionCheckbox"
                                   onchange="checkboxGroup(this)" value="7"/>
                            <label for="agree_check1">
                                <span></span>
                                <p>
                                    유료 포스트 관련 약관 동의(? 샬라샬라,..
                                </p>
                            </label>
                        </div>
                        <div class="inputWrap">
                            <label for="password">사용중인 비밀번호</label>
                            <div class="input_box">
                                <input type="password" name="password" id="password" placeholder="비밀번호 입력"/>
                            </div>
                        </div>
                        <div class="black_btns btns">
                            <button class="btn" type="submit" id="deleteUser">탈퇴하기</button>
                        </div>
                    </form>
                </div>
            </section>
            <!-- ------------------------------------ -->
        </div>
    </div>
    <!--    <script>-->
    <!--        function checkboxGroup(currentCheckbox) {-->
    <!--            const checkboxes = document.getElementsByName("secessionCheckbox");-->

    <!--            // 현재 선택한 체크박스의 값-->
    <!--            const currentValue = currentCheckbox.value;-->

    <!--            for (let i = 0; i < checkboxes.length; i++) {-->
    <!--                // 현재 선택한 체크박스가 아니고, 현재 값과 동일한 값을 가진 체크박스가 선택되어 있다면 선택을 해제합니다.-->
    <!--                if (checkboxes[i] !== currentCheckbox && checkboxes[i].value === currentValue && checkboxes[i].checked) {-->
    <!--                    checkboxes[i].checked = false;-->
    <!--                }-->
    <!--            }-->
    <!--        }-->
    <!--    </script>-->
</th:block>

<th:block layout:fragment="script">
    <!-- 여기에 연결할 외부 javascript 링크를 지정 -->
    <!-- 생성한 CSS 파일은 `/resources/static/js` 에 넣어주세요. -->
    <script type="text/javascript" src="/js/user.js"></script>
    <script type="text/javascript" src="/js/agree.js"></script>
    <script type="text/javascript" src="/js/event.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 탈퇴하기 버튼
            var deleteUserButton = document.getElementById("deleteUser");
            // 비밀번호 입력란
            var passwordInput = document.getElementById("password");

            // 초기에 탈퇴하기 버튼을 비활성화합니다.
            deleteUserButton.disabled = true;

            // 비밀번호 입력란의 값이 변경될 때마다 이벤트를 감지합니다.
            passwordInput.addEventListener("input", function () {
                var password = passwordInput.value.trim(); // 입력된 비밀번호 값

                // 비밀번호가 입력되었는지 확인합니다.
                if (password !== "") {
                    // 입력된 비밀번호가 있을 때 탈퇴하기 버튼을 활성화합니다.
                    deleteUserButton.disabled = false;
                } else {
                    // 입력된 비밀번호가 없을 때 탈퇴하기 버튼을 비활성화합니다.
                    deleteUserButton.disabled = true;
                }
            });

// 탈퇴하기 버튼 클릭 시
            deleteUserButton.addEventListener("click", function (event) {
                // 비밀번호를 서버로 전송하여 비밀번호 확인 요청
                fetch("/user/checkPassword", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({password: passwordInput.value.trim()})
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('서버 응답에 문제가 있습니다.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.isValidPassword) {
                            // 비밀번호가 일치하는 경우
                            if (confirm("정말로 탈퇴하시겠습니까?")) {
                                // 탈퇴 로직 수행
                                fetch("/user/delete", {
                                    method: "POST"
                                })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('탈퇴 처리에 실패했습니다.');
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        alert("탈퇴가 처리되었습니다.");
                                        location.href = "/"; // 메인 페이지로 리다이렉트
                                    })
                                    .catch(error => {
                                        // 탈퇴 처리에 실패한 경우
                                        console.error("Error:", error);
                                        alert("탈퇴 처리에 실패했습니다.");
                                    });
                            }
                        } else {
                            // 비밀번호가 일치하지 않는 경우
                            alert("입력하신 비밀번호가 일치하지 않습니다.");
                        }
                    })
                    .catch(error => {
                        // 서버 응답에 문제가 있는 경우
                        console.error("Error:", error);
                        alert("서버 응답에 문제가 있습니다. 다시 시도해주세요.");
                    });

                // 폼 제출 이벤트 중지
                event.preventDefault();
            });
        });
    </script>
</th:block>
</html>
